<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LC Verification Checklist</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --bg: #f0f2f5;
            --white: #ffffff;
            --text: #333;
            --border: #e0e6ed;
            --success: #20c997;
            --danger: #ff4d4d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .checklist-wrapper {
            width: 90%;
            max-width: 1400px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 90vh;
            overflow: hidden;
            position: relative;
        }

        .header {
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left-pane {
            width: 35%;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background: #fafbff;
        }

        .pane-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            color: var(--secondary);
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .action-bar {
            padding: 15px;
            background: #fff;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .btn-add {
            flex: 1;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn-add:hover { opacity: 0.9; }

        .right-pane {
            width: 65%;
            padding: 30px;
            overflow-y: auto;
            background: white;
        }

        .point-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .point-item:hover {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .point-item.active {
            border-left: 5px solid var(--primary);
            background: #f0f4ff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .edit-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: #eee;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            visibility: hidden;
        }

        .point-item:hover .edit-btn { visibility: visible; }
        .edit-btn:hover { background: #ddd; }

        .field-badge {
            font-size: 0.75em;
            background: #e1e7ff;
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--primary);
            font-weight: bold;
        }

        .details-box {
            background: #fdfdfd;
            border: 1px dashed var(--primary);
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            margin-bottom: 25px;
            font-size: 1.05em;
            line-height: 1.6;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top:0; left:0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header { margin-bottom: 20px; color: var(--secondary); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-family: inherit;
        }

        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .btn-save {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .requirement-list { list-style: none; padding: 0; }
        .requirement-list li { padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; }
    </style>
</head>

<body>

    <div class="checklist-wrapper">
        <div id="loading" class="loading-overlay">
            <div style="text-align: center;">
                <div style="font-size: 2em; margin-bottom: 10px;">‚è≥</div>
                <strong>Fetching Consolidated LC Data...</strong>
                <p id="debug-status" style="font-size: 0.8em; color: #666;"></p>
            </div>
        </div>

        <div class="header">
            <h2 id="lc-title" style="margin:0;">LC Verification</h2>
            <div id="lc-status-info">Session: Processing...</div>
        </div>

        <div class="main-content">
            <div class="left-pane">
                <div class="pane-header">
                    <span>Clause Checklist</span>
                    <span id="progress-text" style="font-size: 0.8em; color: #888;">0% Done</span>
                </div>
                <div class="scroll-area" id="points-container"></div>
                
                <div class="action-bar">
                    <button class="btn-add" onclick="openEditor()">+ Add Manual Clause</button>
                </div>
            </div>

            <div class="right-pane" id="workspace">
                <div style="text-align: center; margin-top: 100px; color: #a0aec0;">
                    <h2 style="font-size: 3em;">üìã</h2>
                    <h3>Select a clause to verify</h3>
                    <p>Details from the consolidated JSON will appear here.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="clauseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-title" style="margin:0;">Edit Clause</h3></div>
            <input type="hidden" id="edit-index">
            
            <div class="form-group">
                <label>Field Type (e.g., 46A, 47A)</label>
                <input type="text" id="field-type" placeholder="46A">
            </div>
            
            <div class="form-group">
                <label>Clause Description</label>
                <textarea id="field-text" rows="5"></textarea>
            </div>

            <div class="form-group">
                <label>Supporting Documents (One per line)</label>
                <textarea id="field-docs" rows="3" placeholder="Enter requirements..."></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-add" style="background: var(--success);" onclick="saveClause()">Save Point</button>
                <button id="delete-btn" class="btn-add" style="background: var(--danger); display:none;" onclick="deleteClause()">Delete</button>
                <button class="btn-add" style="background: #999;" onclick="closeEditor()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // const API_BASE = 'http://localhost:8000';
        const API_BASE = window.location.origin;
        let lcData = { points: [] };

        function setStatus(msg) {
            document.getElementById('debug-status').innerText = msg;
            console.log(msg);
        }

        function getSafeText(textInput) {
            if (typeof textInput === 'string') return textInput;
            if (textInput && typeof textInput === 'object') return textInput.text || JSON.stringify(textInput);
            return "No text content";
        }

        async function initChecklist() {
            setStatus("Initializing...");
            const params = new URLSearchParams(window.location.search);
            const lcNumber = params.get('lc');
            const jobId = params.get('job_id');

            if (!lcNumber || !jobId) {
                document.getElementById('loading').innerHTML = `<div style="color:red; padding:20px; text-align:center;"><h2>Error: Missing Parameters</h2></div>`;
                return;
            }

            try {
                setStatus(`Requesting data for Job: ${jobId}`);
                const response = await fetch(`${API_BASE}/api/result/${jobId}`);
                if (!response.ok) throw new Error(`Server returned ${response.status}`);

                const fullJobData = await response.json();
                const foundLc = fullJobData.consolidated_lcs.find(item => item.lc_number === lcNumber);

                if (!foundLc) throw new Error(`LC #${lcNumber} not found.`);

                const docs = (foundLc.documents_required || []).map(text => ({ type: '46A', text: getSafeText(text) }));
                const conds = (foundLc.additional_conditions || []).map(text => ({ type: '47A', text: getSafeText(text) }));
                
                lcData = {
                    lc_number: foundLc.lc_number,
                    points: [...docs, ...conds].map((c, i) => ({
                        id: i + 1,
                        type: c.type,
                        text: c.text,
                        docs: ["Original Document Required"]
                    }))
                };

                document.getElementById('lc-title').innerText = `LC Verification: #${lcData.lc_number}`;
                document.getElementById('lc-status-info').innerText = `Job ID: ${jobId.substring(0, 8)}`;
                document.getElementById('loading').style.display = 'none';

                renderPoints();
            } catch (err) {
                setStatus("Critical Failure: " + err.message);
                document.getElementById('loading').style.display = 'none';
                alert("Error loading data: " + err.message);
            }
        }

        function renderPoints() {
            const container = document.getElementById('points-container');
            container.innerHTML = '';

            lcData.points.forEach((point, index) => {
                const div = document.createElement('div');
                div.className = 'point-item';
                div.onclick = () => selectPoint(index, div);

                const shortText = point.text.substring(0, 80);

                div.innerHTML = `
                    <input type="checkbox" onclick="event.stopPropagation(); updateProgress();">
                    <div class="point-content">
                        <strong><span class="field-badge">${point.type}</span> Item ${point.id}</strong><br>
                        ${shortText}${point.text.length > 80 ? '...' : ''}
                    </div>
                    <button class="edit-btn" onclick="event.stopPropagation(); openEditor(${index})">Edit</button>
                `;
                container.appendChild(div);
            });
            updateProgress();
        }

        // Editor Functions
        function openEditor(index = null) {
            const modal = document.getElementById('clauseModal');
            document.getElementById('edit-index').value = index !== null ? index : "";
            document.getElementById('modal-title').innerText = index !== null ? "Edit Clause" : "Add New Clause";
            document.getElementById('delete-btn').style.display = index !== null ? "block" : "none";

            if (index !== null) {
                const p = lcData.points[index];
                document.getElementById('field-type').value = p.type;
                document.getElementById('field-text').value = p.text;
                document.getElementById('field-docs').value = p.docs.join('\n');
            } else {
                document.getElementById('field-type').value = "46A";
                document.getElementById('field-text').value = "";
                document.getElementById('field-docs').value = "";
            }

            modal.style.display = 'flex';
        }

        function closeEditor() {
            document.getElementById('clauseModal').style.display = 'none';
        }

        function saveClause() {
            const index = document.getElementById('edit-index').value;
            const type = document.getElementById('field-type').value || "MANUAL";
            const text = document.getElementById('field-text').value || "No content";
            const docs = document.getElementById('field-docs').value.split('\n').filter(d => d.trim() !== "");

            if (index !== "") {
                // Update Existing
                lcData.points[index].type = type;
                lcData.points[index].text = text;
                lcData.points[index].docs = docs.length ? docs : ["Manual Verification"];
            } else {
                // Add New
                lcData.points.push({
                    id: lcData.points.length + 1,
                    type: type,
                    text: text,
                    docs: docs.length ? docs : ["Manual Verification"]
                });
            }

            renderPoints();
            closeEditor();
        }

        function deleteClause() {
            const index = document.getElementById('edit-index').value;
            if (index !== "" && confirm("Delete this clause?")) {
                lcData.points.splice(index, 1);
                // Re-index IDs
                lcData.points.forEach((p, i) => p.id = i + 1);
                renderPoints();
                closeEditor();
            }
        }

        function selectPoint(index, element) {
            const point = lcData.points[index];
            document.querySelectorAll('.point-item').forEach(p => p.classList.remove('active'));
            element.classList.add('active');

            const workspace = document.getElementById('workspace');
            workspace.innerHTML = `
                <span class="doc-tag">Field ${point.type} | Requirement #${point.id}</span>
                <h2 style="margin-top:0; color:var(--secondary)">Verification Workspace</h2>
                
                <div class="details-box">
                    <strong>Full Clause Text:</strong><br><br>${point.text}
                </div>

                <h3>Supporting Documents Needed:</h3>
                <ul class="requirement-list">
                    ${point.docs.map(doc => `<li>üìÑ ${doc}</li>`).join('')}
                </ul>

                <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">Auditor Discrepancy Notes:</label>
                    <textarea id="auditor-note" style="width: 100%; height: 100px; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; font-family: inherit;" 
                        placeholder="Note any inconsistencies..."></textarea>
                    
                    <div style="margin-top:15px; display:flex; justify-content: space-between; align-items:center;">
                        <button class="btn-save" onclick="alert('Progress Saved Locally')">Save Verification</button>
                    </div>
                </div>
            `;
        }

        function updateProgress() {
            const total = document.querySelectorAll('#points-container input[type="checkbox"]').length;
            const checked = document.querySelectorAll('#points-container input[type="checkbox"]:checked').length;
            const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;
            document.getElementById('progress-text').innerText = `${percentage}% Done`;
        }

        window.addEventListener('DOMContentLoaded', initChecklist);
    </script>
</body>
</html>